// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model PassportProfile {
  id                      Int                 @id @default(autoincrement())
  walletId                String
  talentPassportId        Int
  talentUserId            String
  name                    String
  profilePictureUrl       String
  verified                Boolean
  humanCheck              Boolean
  borrowerStatus          BorrowerStatus      @default(NO_HISTORY)
  score                   Int
  activityScore           Int
  identityScore           Int
  skillsScore             Int
  nominationsReceived     Int
  socialsLinked           Int
  followerCount           Int
  
  loans                   Loan[]
  loanApplications        LoanApplication[]
  underwriterProfile      UnderwriterProfile?

  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
}

model UnderwriterProfile {
  id                      Int                 @id @default(autoincrement())  
  name                    String
  status                  UnderwriterStatus   @default(ACTIVE)

  reviewedApplications    LoanApplication[]

  passportProfileId       Int                 @unique
  PassportProfile         PassportProfile     @relation(fields: [passportProfileId], references: [id])

  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
}

model LoanApplication {
  id                      Int                 @id @default(autoincrement())  
  amount                  Float
  availableCreditLine     Float
  xocScore                Int
  builderScore            Int
  nominationsReceived     Int
  followers               Int
  walletId                String
  status                  LoanAppStatus       @default(PENDING)

  reviewedById            Int
  reviewedBy              UnderwriterProfile     @relation(fields: [reviewedById], references: [id])
  applicantId             Int
  applicant               PassportProfile     @relation(fields: [applicantId], references: [id])

  loans                   Loan[]
  
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
}

model Loan {
  id                      Int                 @id @default(autoincrement())
  status                  LoanStatus          @default(OK)
  amount                  Float
  pendingBalance          Float
  dueDate                 DateTime
  isOverdue               Boolean             @default(false)
  walletId                String

  applicantId             Int
  applicant               PassportProfile     @relation(fields: [applicantId], references: [id])
  
  loanApplicationId       Int
  loanApplication         LoanApplication     @relation(fields: [loanApplicationId], references: [id])

  payments                Payment[]
  
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
}

model Payment {
  id                      Int                 @id @default(autoincrement())
  txHash                  String
  walletId                String
  amountPaid              Float
  evmTimestamp            Int
  timestamp               DateTime

  loanId                  Int
  loan                    Loan          @relation(fields: [loanId], references: [id])
  
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
}

enum LoanAppStatus {
  PENDING
  APPROVED
  REJECTED
}

enum LoanStatus {
  OK
  PARTIAL
  LATE
  OVERDUE
  DEFAULTED
  SETTLED
}

enum BorrowerStatus {
  OK
  PARTIAL
  LATE
  OVERDUE
  DEFAULTED
  SETTLED
  NO_HISTORY
}

enum UnderwriterStatus {
  ACTIVE
  PAUSED
  BANNED
  INACTIVE
}